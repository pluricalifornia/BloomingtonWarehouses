<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Bloomington Warehouse Ownership Network Map</title>
    
    <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
        
        #infoPanel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 380px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 99;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-line {
            width: 30px;
            height: 3px;
            margin-right: 10px;
        }
        
        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }
        
        .node-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .warehouse-details {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .relationship-list {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .relationship-item {
            margin: 3px 0;
            font-size: 12px;
        }
        
        #loadingDiv {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        #errorDiv {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            max-width: 400px;
        }
        
        .stats-section {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .warehouse-node-legend {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://js.arcgis.com/4.27/"></script>
</head>
<body>
    <div id="viewDiv"></div>
    <div id="loadingDiv">
        <h3>Loading Network Map...</h3>
        <p>Processing warehouse ownership data</p>
    </div>
    <div id="errorDiv">
        <h3>Error Loading Data</h3>
        <p id="errorMessage"></p>
    </div>
    <div id="infoPanel" style="display: none;">
        <h3>Warehouse Ownership Network</h3>
        <p><strong>Bloomington, CA</strong></p>
        
        <div class="stats-section" id="statsSection">
            <!-- Stats will be populated dynamically -->
        </div>
        
        <div class="legend">
            <h4>Entity Types</h4>
            <div class="legend-item">
                <div class="legend-circle" style="background: #8B4513;"></div>
                <span>Warehouse Property</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background: #2E86C1;"></div>
                <span>Developer</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background: #E74C3C;"></div>
                <span>Purchaser/Owner</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background: #F39C12;"></div>
                <span>Leasee/Tenant</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background: #3498DB;"></div>
                <span>City/Headquarters</span>
            </div>
        </div>
        
        <div class="warehouse-node-legend">
            <h4>Connection Types</h4>
            <div class="legend-item">
                <div class="legend-line" style="background: #2E86C1; width: 4px;"></div>
                <span>Developed by</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #E74C3C; width: 4px;"></div>
                <span>Purchased/Merged</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #F39C12; width: 3px;"></div>
                <span>Leased to</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #27AE60; width: 2px; border-style: dashed;"></div>
                <span>Headquartered in</span>
            </div>
        </div>
        
        <div class="node-info" id="nodeInfo">
            <p>Click on warehouses, entities, or connections for details</p>
        </div>
    </div>

    <script>
        // GitHub content URLs for CSV files
        const githubBaseUrl = "https://raw.githubusercontent.com/pluricalifornia/BloomingtonWarehouses/main/";
        
        // Flag to control using static data vs GitHub data
        let useStaticData = false; // Set to false to attempt GitHub loading
        
        // Static CSV data embedded in the HTML as a fallback
        const csvData = `"Category","Assessor parcel number","Building classification","Year built/approved","Acres","Building sq.ft.",Developer,DevOriginCity,Purchaser/Merger,Category,Leasee,PurchaserOriginCity,LeaseeOriginCity,Endpoint
"Approved","Bloomington Business Park","https://ceqanet.opr.ca.gov/2020120545/3","2025","181","4340000",Howard Industrial Partners LLC,"Lemon Heights, CA",TBD,TBD,TBD,TBD,TBD,"Bloomington, CA"
"Existing","025217367","transit warehouse (truck terminal)","2001","47","1133000",Pacific Industrial,"Newport Beach, CA",Realterm,Purchase,YellowCorp,"Annapolis, MD",TBD,"Bloomington, CA"
"Existing","Bloomington Logistics Center","distribution warehouse","2019","35","827000", Crow holdings Industrial, "Highland Park, TX", ASB Real Estate Investments,Purchase,TBD,"Bethseda, MD",TBD,"Bloomington, CA"
"Existing","025215217","distribution warehouse","2018","28","674000", DCT Industrial Trust,"Evergreen, CO",Prologis,Merger,TBD,"Pacific Heights, CA",TBD,"Bloomington, CA"`;

        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/layers/GraphicsLayer",
            "esri/geometry/Point",
            "esri/geometry/Polyline",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/TextSymbol",
            "esri/rest/locator",
            "esri/rest/support/AddressCandidate",
            "esri/widgets/Popup"
        ], function(Map, MapView, Graphic, GraphicsLayer, Point, Polyline, 
                   SimpleMarkerSymbol, SimpleLineSymbol, TextSymbol, locator, AddressCandidate, Popup) {

            // Cache for geocoded locations
            const geocodeCache = {};
            
            // Predefined coordinates for known cities (fallback)
            const cityCoords = {
                "Bloomington, CA": [-117.396, 34.070],
                "Lemon Heights, CA": [-117.823, 33.765],
                "Newport Beach, CA": [-117.928, 33.618],
                "Annapolis, MD": [-76.492, 38.978],
                "Highland Park, TX": [-96.792, 32.834],
                "Bethesda, MD": [-77.094, 38.984],
                "Bethseda, MD": [-77.094, 38.984], // Handle typo
                "Evergreen, CO": [-105.321, 39.633],
                "Pacific Heights, CA": [-122.447, 37.794],
                "San Francisco, CA": [-122.419, 37.774],
                "Denver, CO": [-104.990, 39.739],
                "Irvine, CA": [-117.826, 33.684],
                "Costa Mesa, CA": [-117.919, 33.641],
                "City of Industry, CA": [-117.958, 34.019],
                "Santa Ana, CA": [-117.868, 33.745],
                "Newport, CA": [-117.928, 33.618],
                "Dallas, TX": [-96.797, 32.777],
                "Los Angeles, CA": [-118.243, 34.052],
                "Chicago, IL": [-87.629, 41.878],
                "New York, NY": [-74.006, 40.713],
                "Washington, DC": [-77.036, 38.895],
                "Miami Beach, FL": [-80.130, 25.790],
                "Allisonville, IN": [-86.004, 39.977],
                "Arcadia, AZ": [-111.093, 33.502],
                "Manhattan, NY": [-73.966, 40.783],
                "Belvedere Tiburon, CA": [-122.456, 37.873],
                "Lake Highlands, TX": [-96.720, 32.885],
                "Pacific Palisades, CA": [-118.535, 34.046],
                "Palm Springs, CA": [-116.545, 33.830],
                "Alessandro Heights, CA": [-117.274, 33.914],
                "La Ca√±ada Flintridge, CA": [-118.200, 34.207],
                "Mentone, CA": [-117.120, 34.065],
                "Newport Coast, CA": [-117.837, 33.600],
                "Brentwood, CA": [-118.472, 34.058],
                "Kihei, HI": [-156.447, 20.785]
            };

            // Geocoding function using ArcGIS locator
            async function geocodeLocation(address) {
                // Check cache first
                if (geocodeCache[address]) {
                    return geocodeCache[address];
                }
                
                // Check predefined coordinates
                if (cityCoords[address]) {
                    geocodeCache[address] = cityCoords[address];
                    return cityCoords[address];
                }
                
                try {
                    // Use ArcGIS geocoding service
                    const geocodeUrl = "https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer";
                    const result = await locator.addressToLocations(geocodeUrl, {
                        address: {
                            SingleLine: address
                        },
                        maxLocations: 1
                    });
                    
                    if (result && result.length > 0) {
                        const coords = [result[0].location.longitude, result[0].location.latitude];
                        geocodeCache[address] = coords;
                        return coords;
                    }
                } catch (error) {
                    console.warn(`Geocoding failed for ${address}:`, error);
                }
                
                // Fallback to default location with offset
                const defaultCoords = [-117.4 + (Math.random() - 0.5) * 2, 34.0 + (Math.random() - 0.5) * 2];
                geocodeCache[address] = defaultCoords;
                return defaultCoords;
            }

            // Function to get coordinates with offset for multiple entities
            const entityOffsets = {};
            async function getCoordinatesForEntity(location, entityName) {
                const baseCoords = await geocodeLocation(location);
                
                // Add offset for multiple entities in same location
                const key = location + "|" + entityName;
                if (!entityOffsets[key]) {
                    const count = Object.keys(entityOffsets).filter(k => k.startsWith(location)).length;
                    const angle = (count * 72) * Math.PI / 180;
                    const offset = 0.05; // Smaller offset for cleaner appearance
                    entityOffsets[key] = [
                        baseCoords[0] + offset * Math.cos(angle),
                        baseCoords[1] + offset * Math.sin(angle)
                    ];
                }
                return entityOffsets[key];
            }

            // Helper function to clean location strings
            function cleanLocation(location) {
                if (!location || typeof location !== 'string') return null;
                
                // Remove extra quotes and whitespace
                let cleaned = location.trim().replace(/["\\"]/g, '').trim();
                
                // List of invalid location values to filter out
                const invalidLocations = ['TBD', 'TBA', 'N/A', 'CA', 'TX', 'Florida', 'Unknown', ''];
                if (invalidLocations.includes(cleaned)) return null;
                
                // Fix common issues
                if (cleaned === 'Bethseda, MD') cleaned = 'Bethesda, MD';
                
                // Add state to city names that are missing it
                const cityStateMap = {
                    'Highland Park': 'Highland Park, TX',
                    'Miami Beach': 'Miami Beach, FL',
                    'Alessandro Heights': 'Alessandro Heights, CA',
                    'La Ca√±ada Flintridge': 'La Ca√±ada Flintridge, CA',
                    'Mentone': 'Mentone, CA',
                    'Newport Coast': 'Newport Coast, CA'
                };
                
                if (cityStateMap[cleaned]) {
                    cleaned = cityStateMap[cleaned];
                }
                
                return cleaned;
            }
            
            // Helper function to clean entity names
            function cleanEntityName(name) {
                if (!name || typeof name !== 'string') return null;
                
                // Remove extra quotes and whitespace
                let cleaned = name.trim().replace(/["\\"]/g, '').trim();
                
                // Filter out invalid entity names
                const invalidNames = ['TBD', 'TBA', 'N/A', 'Purchase', 'Merger', ''];
                if (invalidNames.includes(cleaned)) return null;
                
                return cleaned;
            }

            // Generate warehouse node position around Bloomington
            function getWarehousePosition(index, total) {
                const bloomingtonCoords = cityCoords["Bloomington, CA"];
                const radius = 0.15; // Radius around Bloomington for warehouse placement
                const angle = (index / total) * 2 * Math.PI;
                
                return [
                    bloomingtonCoords[0] + radius * Math.cos(angle),
                    bloomingtonCoords[1] + radius * Math.sin(angle)
                ];
            }

            // Load and parse CSV data
            async function loadData() {
                try {
                    let csvText = csvData;
                    
                    // Try to load from GitHub if not using static data
                    if (!useStaticData) {
                        try {
                            const response = await fetch(githubBaseUrl + "data/WarehouseTracker.csv");
                            if (response.ok) {
                                csvText = await response.text();
                                console.log("Successfully loaded CSV from GitHub");
                            } else {
                                console.warn("Failed to load from GitHub, using embedded data");
                            }
                        } catch (error) {
                            console.warn("Failed to fetch from GitHub, using embedded data:", error);
                        }
                    }
                    
                    // Fix header issue
                    const lines = csvText.split('\n');
                    const fixedHeader = "Category,Assessor parcel number,Building classification,Year built/approved,Acres,Building sq.ft.,Developer,DevOriginCity,Purchaser/Merger,Transaction Type,Leasee,PurchaserOriginCity,LeaseeOriginCity,Endpoint";
                    lines[0] = fixedHeader;
                    const fixedCsv = lines.join('\n');
                    
                    const parsed = Papa.parse(fixedCsv, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });

                    // Initialize collections using plain objects
                    const nodes = {};
                    const edges = [];
                    const warehouses = [];
                    
                    // Add Bloomington as central node first
                    const bloomingtonCoords = await geocodeLocation("Bloomington, CA");
                    nodes["Bloomington, CA"] = {
                        name: "Bloomington, CA",
                        type: "city",
                        subtype: "central",
                        coords: bloomingtonCoords,
                        connections: 0,
                        warehouses: []
                    };

                    // Process each warehouse (row) as a mind map branch
                    let warehouseIndex = 0;
                    for (const row of parsed.data) {
                        const warehouseId = row["Assessor parcel number"] || `Warehouse_${warehouseIndex}`;
                        const warehouseCoords = getWarehousePosition(warehouseIndex, parsed.data.length);
                        
                        // Create warehouse node
                        const warehouseNode = {
                            id: warehouseId,
                            name: row["Building classification"] || warehouseId,
                            type: "warehouse",
                            coords: warehouseCoords,
                            category: row.Category,
                            year: row["Year built/approved"],
                            acres: row.Acres,
                            sqft: row["Building sq.ft."],
                            developer: null,
                            purchaser: null,
                            leasee: null,
                            connections: 0
                        };
                        
                        nodes[warehouseId] = warehouseNode;
                        warehouses.push(warehouseNode);
                        
                        // Connect warehouse to Bloomington
                        edges.push({
                            from: "Bloomington, CA",
                            to: warehouseId,
                            type: "contains",
                            category: "location"
                        });
                        
                        // Process Developer
                        const developerName = cleanEntityName(row.Developer);
                        const devOrigin = cleanLocation(row.DevOriginCity);
                        
                        if (developerName) {
                            warehouseNode.developer = developerName;
                            
                            if (!nodes[developerName]) {
                                const coords = devOrigin ? 
                                    await getCoordinatesForEntity(devOrigin, developerName) :
                                    await getCoordinatesForEntity("California", developerName);
                                nodes[developerName] = {
                                    name: developerName,
                                    type: "entity",
                                    subtype: "developer",
                                    coords: coords,
                                    origin: devOrigin || "Unknown",
                                    connections: 0,
                                    warehouses: []
                                };
                            }
                            
                            nodes[developerName].warehouses.push(warehouseId);
                            
                            if (devOrigin && !nodes[devOrigin]) {
                                const coords = await geocodeLocation(devOrigin);
                                nodes[devOrigin] = {
                                    name: devOrigin,
                                    type: "city",
                                    subtype: "headquarters",
                                    coords: coords,
                                    connections: 0
                                };
                            }
                            
                            // Add edges
                            if (devOrigin) {
                                edges.push({
                                    from: devOrigin,
                                    to: developerName,
                                    type: "headquartered",
                                    category: "developer"
                                });
                            }
                            
                            edges.push({
                                from: developerName,
                                to: warehouseId,
                                type: "developed",
                                category: "developer",
                                year: row["Year built/approved"]
                            });
                        }
                        
                        // Process Purchaser
                        const purchaserName = cleanEntityName(row["Purchaser/Merger"]);
                        const purchOrigin = cleanLocation(row.PurchaserOriginCity);
                        
                        if (purchaserName) {
                            warehouseNode.purchaser = purchaserName;
                            
                            if (!nodes[purchaserName]) {
                                const coords = purchOrigin ? 
                                    await getCoordinatesForEntity(purchOrigin, purchaserName) :
                                    await getCoordinatesForEntity("California", purchaserName);
                                nodes[purchaserName] = {
                                    name: purchaserName,
                                    type: "entity",
                                    subtype: "purchaser",
                                    coords: coords,
                                    origin: purchOrigin || "Unknown",
                                    connections: 0,
                                    warehouses: []
                                };
                            }
                            
                            nodes[purchaserName].warehouses.push(warehouseId);
                            
                            if (purchOrigin && !nodes[purchOrigin]) {
                                const coords = await geocodeLocation(purchOrigin);
                                nodes[purchOrigin] = {
                                    name: purchOrigin,
                                    type: "city",
                                    subtype: "headquarters",
                                    coords: coords,
                                    connections: 0
                                };
                            }
                            
                            if (purchOrigin) {
                                edges.push({
                                    from: purchOrigin,
                                    to: purchaserName,
                                    type: "headquartered",
                                    category: "purchaser"
                                });
                            }
                            
                            edges.push({
                                from: purchaserName,
                                to: warehouseId,
                                type: row["Transaction Type"] || "purchased",
                                category: "purchaser"
                            });
                        }
                        
                        // Process Leasee
                        const leaseeName = cleanEntityName(row.Leasee);
                        const leaseeOrigin = cleanLocation(row.LeaseeOriginCity);
                        
                        if (leaseeName) {
                            warehouseNode.leasee = leaseeName;
                            
                            if (!nodes[leaseeName]) {
                                const coords = leaseeOrigin ? 
                                    await getCoordinatesForEntity(leaseeOrigin, leaseeName) :
                                    await getCoordinatesForEntity("California", leaseeName);
                                nodes[leaseeName] = {
                                    name: leaseeName,
                                    type: "entity",
                                    subtype: "leasee",
                                    coords: coords,
                                    origin: leaseeOrigin || "Unknown",
                                    connections: 0,
                                    warehouses: []
                                };
                            }
                            
                            nodes[leaseeName].warehouses.push(warehouseId);
                            
                            if (leaseeOrigin && !nodes[leaseeOrigin]) {
                                const coords = await geocodeLocation(leaseeOrigin);
                                nodes[leaseeOrigin] = {
                                    name: leaseeOrigin,
                                    type: "city",
                                    subtype: "headquarters",
                                    coords: coords,
                                    connections: 0
                                };
                            }
                            
                            if (leaseeOrigin) {
                                edges.push({
                                    from: leaseeOrigin,
                                    to: leaseeName,
                                    type: "headquartered",
                                    category: "leasee"
                                });
                            }
                            
                            edges.push({
                                from: leaseeName,
                                to: warehouseId,
                                type: "leases",
                                category: "leasee"
                            });
                        }
                        
                        warehouseIndex++;
                    }

                    // Count connections
                    edges.forEach(edge => {
                        const fromNode = nodes[edge.from];
                        const toNode = nodes[edge.to];
                        if (fromNode) fromNode.connections++;
                        if (toNode) toNode.connections++;
                    });

                    // Calculate statistics
                    const stats = {
                        totalWarehouses: warehouses.length,
                        totalAcres: warehouses.reduce((sum, w) => sum + (w.acres || 0), 0),
                        totalSqft: warehouses.reduce((sum, w) => sum + (w.sqft || 0), 0),
                        developers: Object.values(nodes).filter(n => n.subtype === 'developer').length,
                        purchasers: Object.values(nodes).filter(n => n.subtype === 'purchaser').length,
                        leasees: Object.values(nodes).filter(n => n.subtype === 'leasee').length
                    };

                    console.log("Data processing complete. Nodes:", Object.keys(nodes).length, "Edges:", edges.length);
                    return { nodes, edges, warehouses, stats };
                } catch (error) {
                    console.error("Error loading data:", error);
                    throw error;
                }
            }

            // Initialize map and create network
            async function initializeMap() {
                try {
                    // Initialize map
                    const map = new Map({
                        basemap: "gray-vector"
                    });

                    const view = new MapView({
                        container: "viewDiv",
                        map: map,
                        center: [-117.396, 34.070], // Bloomington, CA
                        zoom: 11
                    });

                    // Create graphics layers
                    const edgeLayer = new GraphicsLayer({ title: "Connections" });
                    const nodeLayer = new GraphicsLayer({ title: "Entities" });
                    const labelLayer = new GraphicsLayer({ title: "Labels" });
                    
                    map.addMany([edgeLayer, nodeLayer, labelLayer]);

                    // Wait for view to be ready
                    await view.when();

                    // Load and process data
                    const { nodes, edges, warehouses, stats } = await loadData();
                    
                    // Update statistics panel
                    document.getElementById("statsSection").innerHTML = `
                        <div><strong>${stats.totalWarehouses}</strong> Warehouse Properties</div>
                        <div><strong>${stats.totalAcres.toLocaleString()}</strong> Total Acres</div>
                        <div><strong>${(stats.totalSqft / 1000000).toFixed(1)}M</strong> Total Sq.Ft.</div>
                        <div style="margin-top: 5px;">
                            <strong>${stats.developers}</strong> Developers ‚Ä¢ 
                            <strong>${stats.purchasers}</strong> Purchasers ‚Ä¢ 
                            <strong>${stats.leasees}</strong> Leasees
                        </div>
                    `;
                    
                    // Create edge graphics
                    edges.forEach(edge => {
                        const fromNode = nodes[edge.from];
                        const toNode = nodes[edge.to];
                        
                        if (fromNode && toNode) {
                            const polyline = new Polyline({
                                paths: [[fromNode.coords, toNode.coords]],
                                spatialReference: { wkid: 4326 }
                            });
                            
                            let color, width;
                            switch(edge.type) {
                                case "contains":
                                    color = [139, 69, 19, 0.3]; // Brown for warehouse connection
                                    width = 1;
                                    break;
                                case "developed":
                                    color = [46, 134, 193, 0.8];
                                    width = 4;
                                    break;
                                case "purchased":
                                case "merger":
                                    color = [231, 76, 60, 0.8];
                                    width = 4;
                                    break;
                                case "leases":
                                    color = [243, 156, 18, 0.8];
                                    width = 3;
                                    break;
                                case "headquartered":
                                    color = [39, 174, 96, 0.8];
                                    width = 2;
                                    break;
                                default:
                                    color = [149, 165, 166, 0.8];
                                    width = 2;
                            }
                            
                            const lineSymbol = new SimpleLineSymbol({
                                color: color,
                                width: width,
                                style: edge.type === "headquartered" ? "dash" : "solid"
                            });
                            
                            const graphic = new Graphic({
                                geometry: polyline,
                                symbol: lineSymbol,
                                attributes: edge
                            });
                            
                            edgeLayer.add(graphic);
                        }
                    });
                    
                    // Create node graphics
                    Object.keys(nodes).forEach(nodeKey => {
                        const node = nodes[nodeKey];
                        const point = new Point({
                            longitude: node.coords[0],
                            latitude: node.coords[1],
                            spatialReference: { wkid: 4326 }
                        });
                        
                        let color, size;
                        if (node.type === "warehouse") {
                            color = [139, 69, 19]; // Brown for warehouses
                            size = 14;
                        } else if (node.type === "city") {
                            if (node.subtype === "central") {
                                color = [231, 76, 60]; // Red for Bloomington
                                size = 24;
                            } else {
                                color = [52, 152, 219]; // Blue for other cities
                                size = 10;
                            }
                        } else if (node.type === "entity") {
                            switch(node.subtype) {
                                case "developer":
                                    color = [46, 134, 193];
                                    size = 12 + Math.min(node.connections * 2, 10);
                                    break;
                                case "purchaser":
                                    color = [231, 76, 60];
                                    size = 12 + Math.min(node.connections * 2, 10);
                                    break;
                                case "leasee":
                                    color = [243, 156, 18];
                                    size = 10 + Math.min(node.connections * 2, 8);
                                    break;
                                default:
                                    color = [149, 165, 166];
                                    size = 8;
                            }
                        } else {
                            color = [149, 165, 166];
                            size = 8;
                        }
                        
                        const markerSymbol = new SimpleMarkerSymbol({
                            color: color,
                            size: size,
                            outline: {
                                color: [255, 255, 255],
                                width: 2
                            }
                        });
                        
                        const graphic = new Graphic({
                            geometry: point,
                            symbol: markerSymbol,
                            attributes: Object.assign({}, node, {nodeKey: nodeKey})
                        });
                        
                        nodeLayer.add(graphic);
                        
                        // Add labels for important nodes
                        if (node.type === "city" || node.type === "warehouse" || 
                            (node.type === "entity" && node.connections > 1)) {
                            let labelText = node.name;
                            if (node.type === "warehouse") {
                                labelText = node.id.length > 10 ? "Warehouse" : node.id;
                            }
                            
                            const textSymbol = new TextSymbol({
                                text: labelText,
                                color: [0, 0, 0],
                                haloColor: [255, 255, 255],
                                haloSize: 2,
                                font: {
                                    size: node.type === "warehouse" ? 8 : 
                                          (node.subtype === "central" ? 14 : 10),
                                    weight: node.subtype === "central" ? "bold" : "normal"
                                },
                                yoffset: node.type === "warehouse" ? -12 : -15
                            });
                            
                            const labelGraphic = new Graphic({
                                geometry: point,
                                symbol: textSymbol
                            });
                            
                            labelLayer.add(labelGraphic);
                        }
                    });
                    
                    // Hide loading and show info panel
                    document.getElementById("loadingDiv").style.display = "none";
                    document.getElementById("infoPanel").style.display = "block";
                    
                    // Update extent to show all graphics
                    if (nodeLayer.graphics.length > 0) {
                        view.goTo(nodeLayer.graphics.concat(edgeLayer.graphics), {
                            padding: { top: 50, bottom: 50, left: 50, right: 400 }
                        });
                    }
                    
                    // Handle click events
                    view.on("click", function(event) {
                        view.hitTest(event).then(function(response) {
                            const graphic = response.results[0]?.graphic;
                            if (graphic && graphic.attributes) {
                                const attrs = graphic.attributes;
                                let infoHtml = "";
                                
                                if (attrs.type === "warehouse") {
                                    // Warehouse node clicked - show complete ownership chain
                                    infoHtml = `<h4>Warehouse Property</h4>`;
                                    infoHtml += `<div class="warehouse-details">`;
                                    infoHtml += `<strong>ID:</strong> ${attrs.id}<br>`;
                                    infoHtml += `<strong>Type:</strong> ${attrs.name}<br>`;
                                    if (attrs.category) {
                                        infoHtml += `<strong>Status:</strong> ${attrs.category}<br>`;
                                    }
                                    if (attrs.year) {
                                        infoHtml += `<strong>Year:</strong> ${attrs.year}<br>`;
                                    }
                                    if (attrs.acres) {
                                        infoHtml += `<strong>Size:</strong> ${attrs.acres} acres<br>`;
                                    }
                                    if (attrs.sqft) {
                                        infoHtml += `<strong>Building:</strong> ${attrs.sqft.toLocaleString()} sq.ft.<br>`;
                                    }
                                    infoHtml += `</div>`;
                                    
                                    infoHtml += `<h5>Ownership Chain:</h5>`;
                                    infoHtml += `<div class="relationship-list">`;
                                    if (attrs.developer) {
                                        infoHtml += `<div class="relationship-item">‚Üí <strong>Developed by:</strong> ${attrs.developer}</div>`;
                                    }
                                    if (attrs.purchaser) {
                                        infoHtml += `<div class="relationship-item">‚Üí <strong>Purchased by:</strong> ${attrs.purchaser}</div>`;
                                    }
                                    if (attrs.leasee) {
                                        infoHtml += `<div class="relationship-item">‚Üí <strong>Leased to:</strong> ${attrs.leasee}</div>`;
                                    }
                                    infoHtml += `</div>`;
                                    
                                } else if (attrs.type === "entity") {
                                    // Entity node clicked - show all warehouses they're connected to
                                    infoHtml = `<h4>${attrs.name}</h4>`;
                                    infoHtml += `<p><strong>Role:</strong> ${attrs.subtype.charAt(0).toUpperCase() + attrs.subtype.slice(1)}</p>`;
                                    if (attrs.origin && attrs.origin !== "Unknown") {
                                        infoHtml += `<p><strong>Headquarters:</strong> ${attrs.origin}</p>`;
                                    }
                                    if (attrs.connections) {
                                        infoHtml += `<p><strong>Connections:</strong> ${attrs.connections}</p>`;
                                    }
                                    if (attrs.warehouses && attrs.warehouses.length > 0) {
                                        infoHtml += `<h5>Connected Warehouses (${attrs.warehouses.length}):</h5>`;
                                        infoHtml += `<div class="relationship-list">`;
                                        attrs.warehouses.forEach(warehouseId => {
                                            const warehouse = nodes[warehouseId];
                                            if (warehouse) {
                                                infoHtml += `<div class="relationship-item">‚Ä¢ ${warehouseId}`;
                                                if (warehouse.acres) {
                                                    infoHtml += ` (${warehouse.acres} acres)`;
                                                }
                                                infoHtml += `</div>`;
                                            }
                                        });
                                        infoHtml += `</div>`;
                                    }
                                    
                                } else if (attrs.type === "city") {
                                    // City node clicked
                                    infoHtml = `<h4>${attrs.name}</h4>`;
                                    infoHtml += `<p><strong>Type:</strong> ${attrs.subtype === "central" ? "Central Hub" : "Headquarters Location"}</p>`;
                                    if (attrs.connections) {
                                        infoHtml += `<p><strong>Connections:</strong> ${attrs.connections}</p>`;
                                    }
                                    if (attrs.warehouses && attrs.warehouses.length > 0) {
                                        infoHtml += `<p><strong>Warehouses:</strong> ${attrs.warehouses.length}</p>`;
                                    }
                                    
                                } else if (attrs.from && attrs.to) {
                                    // Edge clicked
                                    infoHtml = `<h4>Connection Details</h4>`;
                                    infoHtml += `<p><strong>From:</strong> ${attrs.from}</p>`;
                                    infoHtml += `<p><strong>To:</strong> ${attrs.to}</p>`;
                                    infoHtml += `<p><strong>Type:</strong> ${attrs.type}</p>`;
                                    if (attrs.category) {
                                        infoHtml += `<p><strong>Category:</strong> ${attrs.category}</p>`;
                                    }
                                    if (attrs.year) {
                                        infoHtml += `<p><strong>Year:</strong> ${attrs.year}</p>`;
                                    }
                                }
                                
                                document.getElementById("nodeInfo").innerHTML = infoHtml || "<p>Click on warehouses, entities, or connections for details</p>";
                            }
                        });
                    });
                    
                    // Add keyboard shortcuts for view control
                    view.on("key-down", function(event) {
                        if (event.key === "r" || event.key === "R") {
                            // Reset view to show all
                            view.goTo(nodeLayer.graphics.concat(edgeLayer.graphics), {
                                padding: { top: 50, bottom: 50, left: 50, right: 400 }
                            });
                        } else if (event.key === "c" || event.key === "C") {
                            // Center on Bloomington
                            view.goTo({
                                center: cityCoords["Bloomington, CA"],
                                zoom: 11
                            });
                        }
                    });
                    
                } catch (error) {
                    console.error("Failed to initialize map:", error);
                    document.getElementById("loadingDiv").style.display = "none";
                    document.getElementById("errorDiv").style.display = "block";
                    document.getElementById("errorMessage").textContent = error.message;
                }
            }

            // Start the application
            initializeMap();
        });
    </script>
</body>
</html>
